# AI Defence 2.0 - Test Environment Dockerfile
FROM node:18-bullseye-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    build-essential \
    python3 \
    cargo \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy package files
COPY npm-aimds/package*.json ./npm-aimds/
COPY npm-aidefense/package*.json ./npm-aidefense/
COPY npm-wasm/package*.json ./npm-wasm/
COPY package*.json ./

# Install dependencies
WORKDIR /app/npm-aimds
RUN npm install --legacy-peer-deps

WORKDIR /app/npm-aidefense
RUN npm install --legacy-peer-deps

WORKDIR /app/npm-wasm
RUN npm install --legacy-peer-deps

# Copy source code
WORKDIR /app
COPY npm-aimds/ ./npm-aimds/
COPY npm-aidefense/ ./npm-aidefense/
COPY npm-wasm/ ./npm-wasm/
COPY AIMDS/ ./AIMDS/
COPY tests/ ./tests/
COPY docs/ ./docs/

# Set environment to test
ENV NODE_ENV=test
ENV CI=true

# Expose ports for testing
EXPOSE 3000 8080 9090

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD node -e "console.log('healthy')" || exit 1

# Default command runs test suite
WORKDIR /app/npm-aimds
CMD ["npm", "test"]
